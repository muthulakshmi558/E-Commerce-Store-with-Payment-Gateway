{% extends "store/base.html" %}
{% load static %}

{% block content %}
<div class="max-w-6xl mx-auto px-6 py-12 grid md:grid-cols-2 gap-10">

  <!-- Customer Details -->
  <div class="bg-white shadow-lg rounded-lg p-6">
    <h2 class="text-2xl font-bold text-primaryPink mb-6">Customer Details</h2>
    <form id="checkout-form">
      {% csrf_token %}
      <div class="grid grid-cols-1 gap-4">
        <input name="first_name" placeholder="First Name" required class="w-full p-3 border rounded focus:ring-2 focus:ring-pink-400">
        <input name="last_name" placeholder="Last Name" class="w-full p-3 border rounded focus:ring-2 focus:ring-pink-400">
        <input name="email" placeholder="Email" type="email" required class="w-full p-3 border rounded focus:ring-2 focus:ring-pink-400">
        <input name="phone" placeholder="Phone" type="tel" required class="w-full p-3 border rounded focus:ring-2 focus:ring-pink-400">
        <input name="city" placeholder="City" class="w-full p-3 border rounded focus:ring-2 focus:ring-pink-400">
        <textarea name="address" placeholder="Address" rows="3" class="w-full p-3 border rounded focus:ring-2 focus:ring-pink-400"></textarea>
      </div>
    </form>
  </div>

  <!-- Order Summary & Payment -->
  <div class="bg-white shadow-lg rounded-lg p-6">
    <h2 class="text-2xl font-bold text-primaryPink mb-6">Order Summary</h2>

    <!-- Cart Items -->
    <div class="divide-y divide-gray-200">
      {% for item in cart_items %}
      <div class="flex items-center py-4">
        <img src="{{ item.product.image.url }}" class="w-12 h-12 object-cover rounded mr-4">
        <div class="flex-1">
          <h3 class="font-semibold">{{ item.product.name }}</h3>
          <p class="text-gray-500 text-sm">Qty: {{ item.quantity }} Ã— â‚¹{{ item.unit_price }}</p>
        </div>
        <div class="text-right font-medium">â‚¹{{ item.line_total }}</div>
      </div>
      {% endfor %}
    </div>

    <!-- Totals -->
    <div class="mt-6 space-y-2 text-right">
      <div class="flex justify-between"><span>Subtotal:</span><span>â‚¹{{ subtotal }}</span></div>
      <div class="flex justify-between"><span>GST ({{ gst_percent }}%):</span><span>â‚¹{{ total_gst }}</span></div>
      <div class="flex justify-between font-bold text-lg"><span>Total:</span><span>â‚¹{{ total }}</span></div>
    </div>

    <!-- Pay Now -->
    <button id="pay-btn" class="mt-6 w-full py-3 bg-primaryPink text-white rounded-lg hover:bg-pink-600 transition text-lg font-semibold">Pay â‚¹{{ total }}</button>
  </div>
</div>

<!-- Success Popup -->
<div id="success-popup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white p-8 rounded-xl text-center shadow-xl relative animate-scale-up">
    
    <!-- Big Green Tick -->
    <div class="w-16 h-16 mx-auto flex items-center justify-center rounded-full bg-green-100 mb-4">
      <svg class="w-10 h-10 text-green-500" fill="none" stroke="currentColor" stroke-width="3"
           viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round"
              d="M5 13l4 4L19 7"></path>
      </svg>
    </div>

    <h2 class="text-2xl font-bold text-gray-800">Payment Successful!</h2>
    <p class="mt-2 text-gray-600">Your invoice will download automatically.</p>
  </div>

  <!-- Confetti Canvas -->
  <canvas id="confetti-canvas" class="fixed inset-0 pointer-events-none"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
document.getElementById('pay-btn').addEventListener('click', async function(){
  const form = document.getElementById('checkout-form');
  const fd = new FormData(form);

  if(!fd.get('first_name') || !fd.get('email') || !fd.get('phone')){
    alert('Please fill required fields!');
    return;
  }

  const csrf = fd.get('csrfmiddlewaretoken');

  const res = await fetch("{% url 'store:checkout' %}", {
    method: 'POST',
    body: fd,
    headers: {'X-CSRFToken': csrf}
  });
  const data = await res.json();

  if(data.status==='ok'){
    const popup = document.getElementById('success-popup');
    popup.classList.remove('hidden');

    // ðŸŽ‰ Confetti animation
    const confettiCanvas = document.getElementById('confetti-canvas');
    const myConfetti = confetti.create(confettiCanvas, { resize: true, useWorker: true });
    myConfetti({
      particleCount: 100,
      spread: 70,
      origin: { y: 0.6 }
    });

    // Download invoice
    const link = document.createElement('a');
    link.href = `/store/invoice/${data.order_id}/`;
    link.download = `invoice_order_${data.order_id}.pdf`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    // Redirect after delay
    setTimeout(function(){
      window.location.href = `/store/order/success/${data.order_id}/`;
    }, 2500);
  } else {
    alert('Something went wrong.');
  }
});
</script>

<style>
@keyframes scale-up {0% {transform: scale(0);} 100% {transform: scale(1);}}
.animate-scale-up {animation: scale-up 0.3s ease forwards;}
</style>
{% endblock %}
